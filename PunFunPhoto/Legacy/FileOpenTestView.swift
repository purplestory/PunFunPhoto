import SwiftUI
import UniformTypeIdentifiers
import ZipArchive

struct FileOpenTestView: View {
    @EnvironmentObject var appState: AppState
    @Environment(\.dismiss) var dismiss
    @ObservedObject var photo1: PhotoState
    @ObservedObject var photo2: PhotoState
    @State private var isImporterPresented = false
    @State private var alertMessage: String?
    @State private var showAlert = false
    @State private var showToast = false
    @State private var toastMessage: String = ""
    @State private var toastType: CenterToastView.AlertType = .success
    
    var body: some View {
        VStack(spacing: 20) {
            Button("ğŸ“‚ pfp íŒŒì¼ ìˆ˜ë™ ì—´ê¸°") {
                isImporterPresented = true
            }
        }
        .fileImporter(
            isPresented: $isImporterPresented,
            allowedContentTypes: [UTType.punfunProject],
            allowsMultipleSelection: false
        ) { result in
            switch result {
            case .success(let urls):
                if let url = urls.first {
                    print("âœ… ì„ íƒëœ íŒŒì¼:", url)
                    Task {
                        await loadProjectManually(from: url)
                    }
                } else {
                    presentAlert(message: "ì„ íƒëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.", type: .warning)
                }
            case .failure(let error):
                presentAlert(message: "íŒŒì¼ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: \(error.localizedDescription)", type: .error)
            }
        }
    }
    
    private func presentAlert(message: String, type: CenterToastView.AlertType = .error) {
        toastMessage = message
        toastType = type
        withAnimation {
            showToast = true
        }
        DispatchQueue.main.asyncAfter(deadline: .now() + 1.8) {
            withAnimation {
                showToast = false
            }
        }
    }
    
    @MainActor
    func loadProjectManually(from url: URL) async {
        let fileManager = FileManager.default
        let tempDir = fileManager.temporaryDirectory
        let unzipFolder = tempDir.appendingPathComponent(UUID().uuidString, isDirectory: true)
        
        do {
            print("ğŸ“‚ ë³µì› ì‹œì‘: \(url.lastPathComponent)")
            
            // ì„ì‹œ ë””ë ‰í† ë¦¬ ìƒì„±
            try fileManager.createDirectory(at: unzipFolder, withIntermediateDirectories: true)
            
            // ë³´ì•ˆ ì ‘ê·¼ ì‹œì‘
            let didStartScopedAccess = url.startAccessingSecurityScopedResource()
            defer {
                if didStartScopedAccess {
                    url.stopAccessingSecurityScopedResource()
                    print("ğŸ”“ ë³´ì•ˆ ì ‘ê·¼ í•´ì œë¨")
                }
            }
            
            // ì••ì¶• í•´ì œ ì‹œë„
            print("ğŸ“¦ ì••ì¶• í•´ì œ ì‹œì‘...")
            let success = SSZipArchive.unzipFile(atPath: url.path, toDestination: unzipFolder.path)
            if !success {
                print("âš ï¸ SSZipArchive ì••ì¶• í•´ì œ ê²°ê³¼: ì‹¤íŒ¨")
                // íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ ë° ê¶Œí•œ í™•ì¸
                print("ğŸ“„ íŒŒì¼ ì¡´ì¬ ì—¬ë¶€: \(fileManager.fileExists(atPath: url.path))")
                if let attributes = try? fileManager.attributesOfItem(atPath: url.path) {
                    print("ğŸ“„ íŒŒì¼ ì†ì„±:", attributes)
                }
                throw NSError(domain: "PunFun", code: 1, userInfo: [NSLocalizedDescriptionKey: "í”„ë¡œì íŠ¸ íŒŒì¼ ì••ì¶• í•´ì œ ì‹¤íŒ¨"])
            }
            
            print("âœ… ì••ì¶• í•´ì œ ì™„ë£Œ")
            
            // ë©”íƒ€ë°ì´í„° ë¡œë“œ
            let metaURL = unzipFolder.appendingPathComponent("meta.json")
            guard fileManager.fileExists(atPath: metaURL.path) else {
                throw NSError(domain: "PunFun", code: 2, userInfo: [NSLocalizedDescriptionKey: "ë©”íƒ€ë°ì´í„° íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."])
            }
            
            print("ğŸ“– ë©”íƒ€ë°ì´í„° ë¡œë“œ ì¤‘...")
            let metaData = try Data(contentsOf: metaURL)
            let project = try JSONDecoder().decode(PunFunPhotoSaveData.self, from: metaData)
            print("âœ… ë©”íƒ€ë°ì´í„° ë¡œë“œ ì™„ë£Œ")
            
            // ì´ë¯¸ì§€ íŒŒì¼ í™•ì¸ ë° ë¡œë“œ
            let path1 = unzipFolder.appendingPathComponent(project.photo1.filePath)
            let path2 = unzipFolder.appendingPathComponent(project.photo2.filePath)
            
            guard fileManager.fileExists(atPath: path1.path),
                  fileManager.fileExists(atPath: path2.path) else {
                throw NSError(domain: "PunFun", code: 3, userInfo: [NSLocalizedDescriptionKey: "ì´ë¯¸ì§€ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."])
            }
            
            print("ğŸ–¼ ì´ë¯¸ì§€ íŒŒì¼ ë¡œë“œ ì¤‘...")
            guard let image1 = UIImage(contentsOfFile: path1.path),
                  let image2 = UIImage(contentsOfFile: path2.path) else {
                throw NSError(domain: "PunFun", code: 4, userInfo: [NSLocalizedDescriptionKey: "ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨"])
            }
            print("âœ… ì´ë¯¸ì§€ íŒŒì¼ ë¡œë“œ ì™„ë£Œ")
            
            // ìƒíƒœ ì—…ë°ì´íŠ¸
            print("ğŸ’¾ ìƒíƒœ ì—…ë°ì´íŠ¸ ì¤‘...")
            photo1.originalImage = image1
            photo1.offset = CGSize(width: project.photo1.offset.x, height: project.photo1.offset.y)
            photo1.scale = project.photo1.scale
            photo1.coverScale = project.photo1.coverScale
            
            photo2.originalImage = image2
            photo2.offset = CGSize(width: project.photo2.offset.x, height: project.photo2.offset.y)
            photo2.scale = project.photo2.scale
            photo2.coverScale = project.photo2.coverScale
            
            // í˜„ì¬ í”„ë¡œì íŠ¸ URL ì—…ë°ì´íŠ¸
            appState.currentProjectURL = url
            print("âœ… ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ")
            
            // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
            presentAlert(message: "í”„ë¡œì íŠ¸ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.")
            
            // ì§€ì—° í›„ ë·° ë‹«ê¸°
            try? await Task.sleep(nanoseconds: 1_500_000_000) // 1.5ì´ˆ ëŒ€ê¸°
            dismiss()
            
        } catch {
            print("âŒ ë³µì› ì‹¤íŒ¨:", error.localizedDescription)
            presentAlert(message: "í”„ë¡œì íŠ¸ ë³µì› ì‹¤íŒ¨: \(error.localizedDescription)", type: .error)
        }
        
        // ì„ì‹œ í´ë” ì •ë¦¬
        do {
            try fileManager.removeItem(at: unzipFolder)
            print("ğŸ§¹ ì„ì‹œ í´ë” ì •ë¦¬ ì™„ë£Œ")
        } catch {
            print("âš ï¸ ì„ì‹œ í´ë” ì •ë¦¬ ì‹¤íŒ¨:", error.localizedDescription)
        }
    }
    // í”„ë¦¬ë·°ìš©
    struct FileOpenTestView_Previews: PreviewProvider {
        static var previews: some View {
            FileOpenTestView(
                photo1: PhotoState(),
                photo2: PhotoState()
            )
            .environmentObject(AppState())
        }
    }
}

